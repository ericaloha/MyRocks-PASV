################################################################################
# This test generates concurrent stress load on the master instance and verifies that:
# (1) HLC values are monotonically increasing on master instance
# (2) Slave retains the HLC values generated by the master
#
# ################################################################################
# Adding big test option for this test.
--source include/big_test.inc
--source include/master-slave.inc

--let $connections= 11
--let $loops= 500
--let $error_simulation= 0
--let $engine = InnoDB

# Include the test which generates the load
--source extra/rpl_tests/rpl_stress_test.inc

connection master;

--let $datadir= `SELECT @@datadir`

# Use mysqlbinlog to parse binlog files and extract the HLC timestamp for all transactions
# Three HLC timestamp lists are generated - 
# (1) HLC timestamp as it comes in the binlog file
# (2) Numerically sorted HLC list
# (3) Numerically sorted HLC list with unique values
# Since HLC is monotonically increasing, all three list should be the same
exec $MYSQL_BINLOG -v -v $datadir/master-bin.0* | grep "Metadata" | rev | cut -f 1 -d " " | rev > $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat;
exec sort -n $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat > $MYSQLTEST_VARDIR/tmp/sorted-hlc.dat;
exec sort -u -n $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat > $MYSQLTEST_VARDIR/tmp/unique-sorted-hlc.dat;

# HLC should be monotonically increasing, so there should not be any diff between unsorted, sorted and unique-sorted hlc list
exec diff $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat $MYSQLTEST_VARDIR/tmp/sorted-hlc.dat;
exec diff $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat $MYSQLTEST_VARDIR/tmp/unique-sorted-hlc.dat;

# Now connect to slave and extract hlc list from the slave binlog files
connection slave;

--let $datadir= `SELECT @@datadir`

exec $MYSQL_BINLOG -v -v $datadir/slave-bin.0* | grep "Metadata" | rev | cut -f 1 -d " " | rev | sort -n > $MYSQLTEST_VARDIR/tmp/slave-sorted-hlc.dat;

# Slave retains master's HLC timestamp. So, there should be no diff between the master and slave HLC list
exec diff $MYSQLTEST_VARDIR/tmp/master-unsorted-hlc.dat $MYSQLTEST_VARDIR/tmp/slave-sorted-hlc.dat;

connection master;
--let $master_applied_hlc= `select applied_hlc from information_schema.database_applied_hlc where database_name like 'test'`

connection slave;
--let $slave_applied_hlc= `select applied_hlc from information_schema.database_applied_hlc where database_name like 'test'`

# master and slave should have the same applied hlc on the test database
if ($master_applied_hlc != $slave_applied_hlc) {
  echo master and slave applied hlc do not match;
} 

--source include/rpl_end.inc
